paths:
  /orders:
    post:
      tags:
        - Orders
      summary: Criar novo pedido
      description: |
        Cria um novo pedido no sistema com validação de estoque.
        
        **Validações automáticas:**
        - Estoque disponível para todos os produtos
        - Usuário existe
        - Cupom válido (se fornecido)
        - Endereço completo
      operationId: createOrder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderCreateInput'
            example:
              usuario_id: 1
              produtos:
                - id_produto: 1
                  quantidade: 2
                - id_produto: 3
                  quantidade: 1
              cupom_id: 1
              endereco:
                logradouro: "Rua das Flores"
                numero: "123"
                complemento: "Apto 45"
                bairro: "Centro"
                cidade: "São Paulo"
                estado: "SP"
                cep: "01234567"
              previsao_entrega: "2024-12-30"
      responses:
        '201':
          description: Pedido criado com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Pedido criado com sucesso"
        '400':
          description: Erro de validação (estoque insuficiente, cupom inválido, etc)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Estoque insuficiente para o produto X"
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  schemas:
    OrderCreateInput:
      type: object
      required:
        - usuario_id
        - produtos
        - endereco
        - previsao_entrega
      properties:
        usuario_id:
          type: integer
          description: ID do usuário que está fazendo o pedido
          example: 1
        produtos:
          type: array
          description: Lista de produtos do pedido
          minItems: 1
          items:
            type: object
            required:
              - id_produto
              - quantidade
            properties:
              id_produto:
                type: integer
                description: ID do produto
                example: 1
              quantidade:
                type: integer
                minimum: 1
                description: Quantidade do produto
                example: 2
        cupom_id:
          type: integer
          nullable: true
          description: ID do cupom de desconto (opcional)
          example: 1
        endereco:
          type: object
          required:
            - logradouro
            - numero
            - bairro
            - cidade
            - estado
            - cep
          properties:
            logradouro:
              type: string
              maxLength: 255
              example: "Rua das Flores"
            numero:
              type: string
              maxLength: 255
              example: "123"
            complemento:
              type: string
              maxLength: 255
              nullable: true
              example: "Apto 45"
            bairro:
              type: string
              maxLength: 255
              example: "Centro"
            cidade:
              type: string
              maxLength: 255
              example: "São Paulo"
            estado:
              type: string
              maxLength: 255
              example: "SP"
            cep:
              type: string
              maxLength: 255
              pattern: '^\d{8}$'
              example: "01234567"
        previsao_entrega:
          type: string
          format: date
          description: Data prevista de entrega (YYYY-MM-DD)
          example: "2024-12-30"
    
    OrderResponse:
      type: object
      properties:
        id:
          type: integer
          example: 1
        usuario_id:
          type: integer
          example: 1
        status:
          type: string
          enum: [pendente, processando, enviado, entregue, cancelado]
          example: "pendente"
        valor_total:
          type: string
          description: Valor total do pedido
          example: "150.00"
        valor_desc:
          type: string
          description: Valor do desconto aplicado
          example: "30.00"
        logradouro:
          type: string
          example: "Rua das Flores"
        numero:
          type: string
          example: "123"
        complemento:
          type: string
          nullable: true
          example: "Apto 45"
        bairro:
          type: string
          example: "Centro"
        cidade:
          type: string
          example: "São Paulo"
        estado:
          type: string
          example: "SP"
        cep:
          type: string
          example: "01234567"
        cod_rastreio:
          type: string
          nullable: true
          example: "BR123456789"
        previsao_entrega:
          type: string
          format: date-time
          example: "2024-12-30T00:00:00.000Z"
        cupom_id:
          type: integer
          nullable: true
          example: 1
